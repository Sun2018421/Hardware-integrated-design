C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 19:36:50 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\keil5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Final) DEBUG OBJECTEXTEND PRINT(
                    -.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "lcd.h"
   2          #include <reg51.h>
   3          #include <stdio.h>
   4          #include <math.h>
   5          typedef unsigned int u16;   //对数据类型进行声明定义
   6          typedef unsigned char u8;
   7          
   8          
   9          char Outputchar[18]={48,49,50,51,52,53,54,55,56,57,43,45,42,47,40,41,46,61};
  10          
  11          float a = 0.0 , b = 0.0, c =0.0 ,ans = 0.0;
  12          u8 flag_a = 0 , flag_b = 0 , flag_c =0 ;
  13          u8 State = 0; //最开始在初始状态
  14          u8 add_sub_flag = 0 ; //1->'+' , 0->'-'
  15          u8 multi_div_flag = 0 ; //1->'*' , 0->'/'
  16          void initA(){
  17   1        a = 0;
  18   1        flag_a = 0;
  19   1      }
  20          void initB(){
  21   1        b = 0 ;
  22   1        flag_b =0 ;
  23   1      }
  24          void initC(){
  25   1        c = 0 ;
  26   1        flag_c = 0;
  27   1      }
  28          void printans(float a){
  29   1        u8 i ;
  30   1        char str[8];
  31   1        sprintf(str,"%f",a);
  32   1        LcdWriteCom(0xc0); //定位到第二行
  33   1        for(i= 0 ; i< 8 ; i++){
  34   2          LcdWriteData(str[i]);
  35   2        }
  36   1      }
  37          void delay(u16 i){  
  38   1        while(i--);
  39   1      }
  40          /*
  41            P17->H1
  42            P16->H2
  43            P15->H3
  44            P14->H4
  45          
  46            P13->L1
  47            P12->L2
  48            P11->L3
  49            P10->L4
  50          */
  51          #define GPIO_KEY P1 //  0000 0000
  52          #define GPIO_BUTTON P3 //独立按键使用P3
  53          sbit K1 = P3^0; sbit K2 = P3^1;
  54          sbit K3 = P3^2; sbit K4 = P3^3;
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 19:36:50 PAGE 2   

  55          sbit K5 = P3^4; sbit K6 = P3^5;
  56          sbit K7 = P3^6; sbit K8 = P3^7;
  57          u8 isNum(u8 num){
  58   1        if((num>=0)&&(num<=9))
  59   1          return 1;
  60   1        return 0;
  61   1      }
  62          
  63          u8 KeyDown(void)
  64          {
  65   1        u8 KeyValue= 127;
  66   1        char adelay=0;
  67   1        GPIO_KEY=0x0f;
  68   1        if(GPIO_KEY!=0x0f)//读取按键是否按下
  69   1        {
  70   2          delay(1000);//延时10ms进行消抖
  71   2          if(GPIO_KEY!=0x0f)//再次检测键盘是否按下
  72   2          { 
  73   3            //测试列
  74   3            GPIO_KEY=0X0F;
  75   3            switch(GPIO_KEY)
  76   3            {
  77   4              case(0X07): KeyValue=0;break;
  78   4              case(0X0b): KeyValue=1;break;
  79   4              case(0X0d): KeyValue=2;break;
  80   4              case(0X0e): KeyValue=3;break;
  81   4            }
  82   3            //测试行
  83   3            GPIO_KEY=0XF0;
  84   3            switch(GPIO_KEY)
  85   3            {
  86   4              case(0X70): KeyValue=KeyValue;break;
  87   4              case(0Xb0): KeyValue=KeyValue+4;break;
  88   4              case(0Xd0): KeyValue=KeyValue+8;break;
  89   4              case(0Xe0): KeyValue=KeyValue+12;break;
  90   4            }
  91   3            
  92   3          }
  93   2        }
  94   1        //delay(1000);
  95   1        while((adelay<50)&&(GPIO_KEY!=0xf0))   //检测按键松手检测
  96   1        {
  97   2          delay(160);
  98   2          adelay++;
  99   2        }
 100   1        if(KeyValue == 15)
 101   1          return 18;
 102   1        return KeyValue;
 103   1      }
 104          
 105          
 106          /*
 107          从独立按键输入字符
 108          */
 109          u8 keypros(){
 110   1        
 111   1        
 112   1        GPIO_BUTTON = 0xff;
 113   1        delay(1000);
 114   1        if(K1 == 0){
 115   2          while(!K1);
 116   2          return 10;  //'+'
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 19:36:50 PAGE 3   

 117   2        }
 118   1        if(K2 == 0){
 119   2          while(!K2);
 120   2          return 11; 
 121   2        }
 122   1        if(K3 == 0){
 123   2          while(!K3);
 124   2          return 12; 
 125   2        }
 126   1        if(K4 == 0){
 127   2          while(!K4);
 128   2          return 13; 
 129   2        }
 130   1        if(K5 == 0){
 131   2          while(!K5);
 132   2          return 14; 
 133   2        }
 134   1        if(K6 == 0){
 135   2          while(!K6);
 136   2          return 15; 
 137   2        }
 138   1        if(K7 == 0){
 139   2          while(!K7);
 140   2          return 16; 
 141   2        }
 142   1        if(K8 == 0){
 143   2          while(!K8);
 144   2          return 17; 
 145   2        }
 146   1        return 127;
 147   1      }
 148          
 149          u8 Getch(){
 150   1        u8 op = 127;
 151   1        while(op==127){
 152   2          op = keypros();
 153   2          if(op!=127)
 154   2            return op ;
 155   2          op = KeyDown();
 156   2          if(op!=127){
 157   3          return op;
 158   3          }
 159   2        }
 160   1        return 127;
 161   1      }
 162          
 163          /* if 不是小数
 164          //    更新小数flag
 165          //  update 
 166             if 不是小数
 167                *10 + nun
 168             是小数
 169                根据小数计算
 170          //
 171          */
 172          
 173          void clear(){
 174   1          //  LCD1602_E = 0;
 175   1          LcdWriteCom(0x01);
 176   1          initA();
 177   1          initB();
 178   1          initC();
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 19:36:50 PAGE 4   

 179   1          State = 0;
 180   1      }
 181          void function_S0(){
 182   1        u8 num = Getch();
 183   1        if(num == 17){
 184   2          LcdWriteData(Outputchar[num]);
 185   2          printans(a);
 186   2        }
 187   1        else if(num == 16){
 188   2          if(flag_a == 0){
 189   3            flag_a = 1;
 190   3            LcdWriteData(Outputchar[num]);
 191   3          }
 192   2        } 
 193   1        else if(num == 18){
 194   2        clear();
 195   2        }
 196   1        else {
 197   2          if(isNum(num)==1){
 198   3            if(flag_a == 0){
 199   4                a = a*10 +num;
 200   4            }
 201   3            else{
 202   4                a += num*(float)pow(0.1,flag_a);
 203   4                flag_a ++;
 204   4            }
 205   3          }
 206   2          else if(num == 10){  // + -
 207   3        //    initB();
 208   3            add_sub_flag = 1;
 209   3            State = 1;
 210   3          }
 211   2          else if(num == 11){
 212   3        //    initB();
 213   3            add_sub_flag = 0 ;
 214   3            State = 1;
 215   3          }
 216   2          else if(num ==12 ){
 217   3      //      initC();
 218   3            State = 5;
 219   3            multi_div_flag = 1;
 220   3          }// * /
 221   2          else if(num == 13){
 222   3        //    initC();
 223   3            State =5 ;
 224   3            multi_div_flag = 0;
 225   3          }
 226   2          LcdWriteData(Outputchar[num]);
 227   2        }
 228   1      
 229   1      }
 230          
 231            
 232          
 233          void function_S1(){
 234   1        u8 num = Getch();
 235   1        initB();
 236   1        if(isNum(num)==1){
 237   2          b = num;
 238   2          State = 2;
 239   2          LcdWriteData(Outputchar[num]);
 240   2        }
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 19:36:50 PAGE 5   

 241   1        else if(num == 18){
 242   2          clear();
 243   2        }
 244   1      }
 245          
 246          void function_S2(){
 247   1        u8 num = Getch();
 248   1        if(num==17){
 249   2          State = 0;
 250   2          if(add_sub_flag ==1){
 251   3            a = a+b;
 252   3          }
 253   2          else 
 254   2            a = a-b;
 255   2          LcdWriteData(Outputchar[num]);
 256   2          printans(a);
 257   2        }
 258   1        else if(num == 18){
 259   2          clear();
 260   2        }
 261   1        else if(num == 16){
 262   2          if(flag_b == 0){
 263   3            flag_b = 1;
 264   3            LcdWriteData(Outputchar[num]);
 265   3          }
 266   2        } 
 267   1        else{
 268   2          if(isNum(num) == 1){
 269   3            if(flag_b == 0){
 270   4                b = b*10 +num;
 271   4            }
 272   3            else{
 273   4                b += num*(float)pow(0.1,flag_b);
 274   4                flag_b ++;
 275   4            }
 276   3          }
 277   2          else if (num== 12){  //*
 278   3          //  initC();
 279   3            State = 3;
 280   3            multi_div_flag = 1;
 281   3          }
 282   2          else if (num == 13){ // /
 283   3            //initC();
 284   3            State = 3; 
 285   3            multi_div_flag = 0;
 286   3          }
 287   2          else if (num == 10){
 288   3            if(add_sub_flag ==1){
 289   4              a = a+b;
 290   4            }
 291   3            else 
 292   3              a = a-b;
 293   3            State = 1;
 294   3            add_sub_flag = 1;
 295   3          }
 296   2          else if (num == 11){
 297   3            if(add_sub_flag ==1){
 298   4              a = a+b;
 299   4            }
 300   3            else 
 301   3              a = a-b;
 302   3            State = 1;
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 19:36:50 PAGE 6   

 303   3            add_sub_flag = 0;
 304   3            }
 305   2          LcdWriteData(Outputchar[num]);
 306   2        }
 307   1      }
 308          
 309          void function_S3(){
 310   1        u8 num = Getch();
 311   1        initC();
 312   1        if(isNum(num)==1){
 313   2          c = num;
 314   2          State = 4;
 315   2          LcdWriteData(Outputchar[num]);
 316   2        }
 317   1        else if(num == 18){
 318   2          clear();
 319   2        }
 320   1      }
 321          
 322          void function_S4(){
 323   1        u8 num = Getch();
 324   1        if(isNum(num)==1){
 325   2            if(flag_c == 0){
 326   3                c = c*10 +num;
 327   3            }
 328   2            else{
 329   3                c += num*(float)pow(0.1,flag_c);
 330   3                flag_c ++;
 331   3            }
 332   2        }
 333   1        else if(num == 16){
 334   2          if(flag_c == 0){
 335   3            flag_c = 1;
 336   3          }
 337   2        } 
 338   1        else if(num == 10){ // +
 339   2          if(add_sub_flag == 1){
 340   3            if(multi_div_flag ==1)
 341   3              a= a+b*c;
 342   3            else
 343   3              a= a+b/c;
 344   3          }
 345   2          else{ 
 346   3            if(multi_div_flag ==1)
 347   3              a= a-b*c;
 348   3            else
 349   3              a= a-b/c;
 350   3          }
 351   2      //    initB();
 352   2      //    initC();
 353   2          add_sub_flag = 1;
 354   2          State = 1;
 355   2        }
 356   1        else if(num == 11){
 357   2          if(add_sub_flag == 1){
 358   3            if(multi_div_flag ==1)
 359   3              a= a+b*c;
 360   3            else
 361   3              a= a+b/c;
 362   3          }
 363   2          else{ 
 364   3            if(multi_div_flag ==1)
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 19:36:50 PAGE 7   

 365   3              a= a-b*c;
 366   3            else
 367   3              a= a-b/c;
 368   3          }
 369   2      //    initB();
 370   2      //    initC();
 371   2          add_sub_flag = 0;
 372   2          State = 1;
 373   2        }
 374   1        else if(num == 12){ //*
 375   2          if(multi_div_flag == 1){
 376   3            b = b*c ;
 377   3          }
 378   2          else 
 379   2            b = b/c;
 380   2      //    initC();
 381   2          State =3;
 382   2          multi_div_flag = 1;
 383   2        }
 384   1        else if(num == 13){ // /
 385   2          if(multi_div_flag == 1){
 386   3            b = b*c ;
 387   3          }
 388   2          else 
 389   2            b = b/c;
 390   2      //    initC();
 391   2          State =3;
 392   2          multi_div_flag = 0;
 393   2        }
 394   1        else if(num == 17){
 395   2          if(add_sub_flag == 1){
 396   3            if(multi_div_flag ==1)
 397   3              a= a+b*c;
 398   3            else
 399   3              a= a+b/c;
 400   3          }
 401   2          else{ 
 402   3            if(multi_div_flag ==1)
 403   3              a= a-b*c;
 404   3            else
 405   3              a= a-b/c;
 406   3          }
 407   2      //    initB();
 408   2      //    initC();
 409   2          add_sub_flag = 0;
 410   2          State = 0;
 411   2        }
 412   1        
 413   1        if(num!=17){
 414   2          LcdWriteData(Outputchar[num]);
 415   2        }
 416   1        else if(num == 18){
 417   2          clear();
 418   2        }
 419   1        else{
 420   2          LcdWriteData(Outputchar[num]);
 421   2          printans(a);
 422   2        }
 423   1      }
 424          
 425          void function_S5(){
 426   1        u8 num = Getch();
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 19:36:50 PAGE 8   

 427   1        initC();
 428   1        if(isNum(num)==1){
 429   2          c = num;
 430   2          State = 6;
 431   2          LcdWriteData(Outputchar[num]);
 432   2        }
 433   1        else if(num==18){
 434   2          clear();
 435   2        }
 436   1      }
 437          
 438          void function_S6(){
 439   1        u8 num = Getch();
 440   1        if(isNum(num)==1){
 441   2          if(flag_c == 0){
 442   3              c = c*10 +num;
 443   3          }
 444   2          else{
 445   3              c += num*(float)pow(0.1,flag_c);
 446   3              flag_c ++;
 447   3          }
 448   2        }
 449   1        else if(num == 16){
 450   2          if(flag_c== 0){
 451   3            flag_c = 1;
 452   3          }
 453   2        } 
 454   1        else if(num == 10){ // +
 455   2          if(multi_div_flag==1){
 456   3            a = a*c;
 457   3            State = 1;
 458   3            add_sub_flag = 1; 
 459   3          }
 460   2          else{
 461   3            a = a/c;
 462   3            State = 1;
 463   3            add_sub_flag = 1; 
 464   3          }
 465   2      //    initC();
 466   2        }
 467   1        else if (num == 11){ // -
 468   2          if(multi_div_flag==1){
 469   3            a = a*c;
 470   3            State = 1;
 471   3            add_sub_flag = 0; 
 472   3          }
 473   2          else{
 474   3            a = a/c;
 475   3            State = 1;
 476   3            add_sub_flag = 0; 
 477   3          }
 478   2      //    initC();
 479   2        }
 480   1        else if(num ==12){ // *
 481   2          if(multi_div_flag==1){
 482   3            a = a*c;
 483   3            multi_div_flag = 1; 
 484   3          }
 485   2          else{
 486   3            a = a/c;
 487   3            multi_div_flag = 1; 
 488   3          }
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 19:36:50 PAGE 9   

 489   2          State = 5;
 490   2      //    initC();
 491   2        }
 492   1        else if (num == 13){ // /
 493   2          if(multi_div_flag==1){
 494   3            a = a*c;
 495   3            multi_div_flag = 0; 
 496   3          }
 497   2          else{
 498   3            a = a/c;
 499   3            multi_div_flag = 0; 
 500   3          }
 501   2      //    initC();
 502   2          State = 5;
 503   2        }
 504   1        else if(num == 17){ // ==
 505   2          State = 0;
 506   2          if(multi_div_flag==1){
 507   3            a = a*c;
 508   3          }
 509   2          else{
 510   3            a = a/c;
 511   3          }
 512   2      //    initB();
 513   2      //    initC();
 514   2        }
 515   1        
 516   1        if(num == 17){
 517   2          LcdWriteData(Outputchar[num]);
 518   2          printans(a);
 519   2        }else if(num == 18){
 520   2          clear();
 521   2        }
 522   1        else{
 523   2          LcdWriteData(Outputchar[num]);
 524   2        }
 525   1      }
 526          void function_S7(){
 527   1        u8 num = Getch();
 528   1      }
 529          //todo : a 的flag没有更新过
 530          void main(){
 531   1        LcdInit();
 532   1        while(1){
 533   2          switch(State){
 534   3            case 0:
 535   3              function_S0();
 536   3              break;
 537   3            case 1:
 538   3              function_S1();
 539   3              break;
 540   3            case 2:
 541   3              function_S2();
 542   3              break;
 543   3            case 3:
 544   3              function_S3();
 545   3              break;
 546   3            case 4:
 547   3              function_S4();
 548   3              break;
 549   3            case 5:
 550   3              function_S5();
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 19:36:50 PAGE 10  

 551   3              break;
 552   3            case 6:
 553   3              function_S6();
 554   3              break;
 555   3            case 7:
 556   3              function_S7(); //结果状态
 557   3              break;  
 558   3          }
 559   2        }
 560   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2775    ----
   CONSTANT SIZE    =      3    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     40      19
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
