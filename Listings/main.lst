C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 18:00:46 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\keil5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Final) DEBUG OBJECTEXTEND PRINT(
                    -.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "lcd.h"
   2          #include <reg51.h>
   3          #include <stdio.h>
   4          #include <math.h>
   5          typedef unsigned int u16;   //对数据类型进行声明定义
   6          typedef unsigned char u8;
   7          
   8          
   9          char Outputchar[18]={48,49,50,51,52,53,54,55,56,57,43,45,42,47,40,41,46,61};
  10          
  11          float a = 0.0 , b = 0.0, c =0.0 ,ans = 0.0;
  12          u8 flag_a = 0 , flag_b = 0 , flag_c =0 ;
  13          u8 State = 0; //最开始在初始状态
  14          u8 add_sub_flag = 0 ; //1->'+' , 0->'-'
  15          u8 multi_div_flag = 0 ; //1->'*' , 0->'/'
  16          
  17          void initA(){
  18   1        a = 0 ;
  19   1        flag_a = 0;
  20   1      }
  21          void initB(){
  22   1        b = 0 ;
  23   1        flag_b =0 ;
  24   1      }
  25          void initC(){
  26   1        c = 0 ;
  27   1        flag_c = 0;
  28   1      }
  29          void printans(float a){
  30   1        u8 i ;
  31   1        char str[8];
  32   1        sprintf(str,"%f",a);
  33   1        LcdWriteCom(0xc0); //定位到第二行
  34   1        for(i= 0 ; i< 8 ; i++){
  35   2          LcdWriteData(str[i]);
  36   2        }
  37   1      }
  38          void delay(u16 i){  
  39   1        while(i--);
  40   1      }
  41          /*
  42            P17->H1
  43            P16->H2
  44            P15->H3
  45            P14->H4
  46          
  47            P13->L1
  48            P12->L2
  49            P11->L3
  50            P10->L4
  51          */
  52          #define GPIO_KEY P1 //  0000 0000
  53          #define GPIO_BUTTON P3 //独立按键使用P3
  54          sbit K1 = P3^0; sbit K2 = P3^1;
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 18:00:46 PAGE 2   

  55          sbit K3 = P3^2; sbit K4 = P3^3;
  56          sbit K5 = P3^4; sbit K6 = P3^5;
  57          sbit K7 = P3^6; sbit K8 = P3^7;
  58          u8 isNum(u8 num){
  59   1        if((num>=0)&&(num<=9))
  60   1          return 1;
  61   1        return 0;
  62   1      }
  63          
  64          u8 KeyDown(void)
  65          {
  66   1        u8 KeyValue= 127;
  67   1        char adelay=0;
  68   1        GPIO_KEY=0x0f;
  69   1        if(GPIO_KEY!=0x0f)//读取按键是否按下
  70   1        {
  71   2          delay(1000);//延时10ms进行消抖
  72   2          if(GPIO_KEY!=0x0f)//再次检测键盘是否按下
  73   2          { 
  74   3            //测试列
  75   3            GPIO_KEY=0X0F;
  76   3            switch(GPIO_KEY)
  77   3            {
  78   4              case(0X07): KeyValue=0;break;
  79   4              case(0X0b): KeyValue=1;break;
  80   4              case(0X0d): KeyValue=2;break;
  81   4              case(0X0e): KeyValue=3;break;
  82   4            }
  83   3            //测试行
  84   3            GPIO_KEY=0XF0;
  85   3            switch(GPIO_KEY)
  86   3            {
  87   4              case(0X70): KeyValue=KeyValue;break;
  88   4              case(0Xb0): KeyValue=KeyValue+4;break;
  89   4              case(0Xd0): KeyValue=KeyValue+8;break;
  90   4              case(0Xe0): KeyValue=KeyValue+12;break;
  91   4            }
  92   3            
  93   3          }
  94   2        }
  95   1        //delay(1000);
  96   1        while((adelay<50)&&(GPIO_KEY!=0xf0))   //检测按键松手检测
  97   1        {
  98   2          delay(150);
  99   2          adelay++;
 100   2        }
 101   1        return KeyValue;
 102   1      }
 103          
 104          
 105          /*
 106          从独立按键输入字符
 107          */
 108          u8 keypros(){
 109   1        
 110   1        
 111   1        GPIO_BUTTON = 0xff;
 112   1        delay(1000);
 113   1        if(K1 == 0){
 114   2          while(!K1);
 115   2          return 10;  //'+'
 116   2        }
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 18:00:46 PAGE 3   

 117   1        if(K2 == 0){
 118   2          while(!K2);
 119   2          return 11; 
 120   2        }
 121   1        if(K3 == 0){
 122   2          while(!K3);
 123   2          return 12; 
 124   2        }
 125   1        if(K4 == 0){
 126   2          while(!K4);
 127   2          return 13; 
 128   2        }
 129   1        if(K5 == 0){
 130   2          while(!K5);
 131   2          return 14; 
 132   2        }
 133   1        if(K6 == 0){
 134   2          while(!K6);
 135   2          return 15; 
 136   2        }
 137   1        if(K7 == 0){
 138   2          while(!K7);
 139   2          return 16; 
 140   2        }
 141   1        if(K8 == 0){
 142   2          while(!K8);
 143   2          return 17; 
 144   2        }
 145   1        return 127;
 146   1      }
 147          
 148          u8 Getch(){
 149   1        u8 op = 127;
 150   1        while(op==127){
 151   2          op = keypros();
 152   2          if(op!=127)
 153   2            return op ;
 154   2          op = KeyDown();
 155   2          if(op!=127){
 156   3          return op;
 157   3          }
 158   2        }
 159   1        return 127;
 160   1      }
 161          
 162          /* if 不是小数
 163          //    更新小数flag
 164          //  update 
 165             if 不是小数
 166                *10 + nun
 167             是小数
 168                根据小数计算
 169          //
 170          */
 171          void function_S0(){
 172   1        u8 num = Getch();
 173   1        if(num == 17){
 174   2          LcdWriteData(Outputchar[num]);
 175   2          printans(a);
 176   2        }
 177   1        else if(num == 16){
 178   2          if(flag_a == 0){
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 18:00:46 PAGE 4   

 179   3            flag_a = 1;
 180   3            LcdWriteData(Outputchar[num]);
 181   3          }
 182   2        } 
 183   1        else {
 184   2          if(isNum(num)==1){
 185   3            if(flag_a == 0){
 186   4                a = a*10 +num;
 187   4            }
 188   3            else{
 189   4                a += num*(float)pow(0.1,flag_a);
 190   4                flag_a ++;
 191   4            }
 192   3          }
 193   2          else if(num == 10){  // + -
 194   3            initB();
 195   3            add_sub_flag = 1;
 196   3            State = 1;
 197   3          }
 198   2          else if(num == 11){
 199   3            initB();
 200   3            add_sub_flag = 0 ;
 201   3            State = 1;
 202   3          }
 203   2          else if(num ==12 ){
 204   3            initC();
 205   3            State = 5;
 206   3            multi_div_flag = 1;
 207   3          }// * /
 208   2          else if(num == 13){
 209   3            initC();
 210   3            State =5 ;
 211   3            multi_div_flag = 0;
 212   3          }
 213   2          LcdWriteData(Outputchar[num]);
 214   2        }
 215   1      }
 216          
 217            
 218          
 219          void function_S1(){
 220   1        u8 num = Getch();
 221   1        if(isNum(num)==1){
 222   2          b = num;
 223   2          State = 2;
 224   2          LcdWriteData(Outputchar[num]);
 225   2        }
 226   1        else {
 227   2        }
 228   1      }
 229          
 230          void function_S2(){
 231   1        u8 num = Getch();
 232   1        if(num==17){
 233   2          State = 0;
 234   2          if(add_sub_flag ==1){
 235   3            a = a+b;
 236   3          }
 237   2          else 
 238   2            a = a-b;
 239   2          LcdWriteData(Outputchar[num]);
 240   2          printans(a);
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 18:00:46 PAGE 5   

 241   2        }
 242   1        else if(num == 16){
 243   2          if(flag_b == 0){
 244   3            flag_b = 1;
 245   3            LcdWriteData(Outputchar[num]);
 246   3          }
 247   2        } 
 248   1        else{
 249   2          if(isNum(num) == 1){
 250   3            if(flag_b == 0){
 251   4                b = b*10 +num;
 252   4            }
 253   3            else{
 254   4                b += num*(float)pow(0.1,flag_b);
 255   4                flag_b ++;
 256   4            }
 257   3          }
 258   2          else if (num== 12){  //*
 259   3            initC();
 260   3            State = 3;
 261   3            multi_div_flag = 1;
 262   3          }
 263   2          else if (num == 13){ // /
 264   3            initC();
 265   3            State = 3; 
 266   3            multi_div_flag = 0;
 267   3            LcdWriteData(Outputchar[num]);
 268   3          }
 269   2          else if (num == 10){
 270   3            if(add_sub_flag ==1){
 271   4              a = a+b;
 272   4            }
 273   3            else 
 274   3              a = a-b;
 275   3            State = 1;
 276   3            add_sub_flag = 1;
 277   3          }
 278   2          else if (num == 11){
 279   3            if(add_sub_flag ==1){
 280   4              a = a+b;
 281   4            }
 282   3            else 
 283   3              a = a-b;
 284   3            State = 1;
 285   3            add_sub_flag = 0;
 286   3            }
 287   2          LcdWriteData(Outputchar[num]);
 288   2        }
 289   1      }
 290          
 291          void function_S3(){
 292   1        u8 num = Getch();
 293   1        if(isNum(num)==1){
 294   2          c = num;
 295   2          State = 4;
 296   2          LcdWriteData(Outputchar[num]);
 297   2        }
 298   1        else {
 299   2        }
 300   1      }
 301          
 302          void function_S4(){
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 18:00:46 PAGE 6   

 303   1        u8 num = Getch();
 304   1        if(isNum(num)==1){
 305   2            if(flag_c == 0){
 306   3                c = c*10 +num;
 307   3            }
 308   2            else{
 309   3                c += num*(float)pow(0.1,flag_c);
 310   3                flag_c ++;
 311   3            }
 312   2        }
 313   1        else if(num == 16){
 314   2          if(flag_c == 0){
 315   3            flag_c = 1;
 316   3          }
 317   2        } 
 318   1        else if(num == 10){ // +
 319   2          if(add_sub_flag == 1){
 320   3            if(multi_div_flag ==1)
 321   3              a= a+b*c;
 322   3            else
 323   3              a= a+b/c;
 324   3          }
 325   2          else{ 
 326   3            if(multi_div_flag ==1)
 327   3              a= a-b*c;
 328   3            else
 329   3              a= a-b/c;
 330   3          }
 331   2          initB();
 332   2          initC();
 333   2          add_sub_flag = 1;
 334   2          State = 1;
 335   2        }
 336   1        else if(num == 11){
 337   2          if(add_sub_flag == 1){
 338   3            if(multi_div_flag ==1)
 339   3              a= a+b*c;
 340   3            else
 341   3              a= a+b/c;
 342   3          }
 343   2          else{ 
 344   3            if(multi_div_flag ==1)
 345   3              a= a-b*c;
 346   3            else
 347   3              a= a-b/c;
 348   3          }
 349   2          initB();
 350   2          initC();
 351   2          add_sub_flag = 0;
 352   2          State = 1;
 353   2        }
 354   1        else if(num == 12){ //*
 355   2          if(multi_div_flag == 1){
 356   3            b = b*c ;
 357   3          }
 358   2          else 
 359   2            b = b/c;
 360   2          initC();
 361   2          State =3;
 362   2          multi_div_flag = 1;
 363   2        }
 364   1        else if(num == 13){ // /
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 18:00:46 PAGE 7   

 365   2          if(multi_div_flag == 1){
 366   3            b = b*c ;
 367   3          }
 368   2          else 
 369   2            b = b/c;
 370   2          initC();
 371   2          State =3;
 372   2          multi_div_flag = 0;
 373   2        }
 374   1        else if(num == 17){
 375   2          if(add_sub_flag == 1){
 376   3            if(multi_div_flag ==1)
 377   3              a= a+b*c;
 378   3            else
 379   3              a= a+b/c;
 380   3          }
 381   2          else{ 
 382   3            if(multi_div_flag ==1)
 383   3              a= a-b*c;
 384   3            else
 385   3              a= a-b/c;
 386   3          }
 387   2          initB();
 388   2          initC();
 389   2          add_sub_flag = 0;
 390   2          State = 0;
 391   2        }
 392   1        
 393   1        if(num!=17){
 394   2          LcdWriteData(Outputchar[num]);
 395   2        }
 396   1        else{
 397   2          LcdWriteData(Outputchar[num]);
 398   2          printans(a);
 399   2        }
 400   1      }
 401          
 402          void function_S5(){
 403   1        u8 num = Getch();
 404   1        if(isNum(num)==1){
 405   2          c = num;
 406   2          State = 6;
 407   2          LcdWriteData(Outputchar[num]);
 408   2        }
 409   1        else {
 410   2        }
 411   1      }
 412          
 413          void function_S6(){
 414   1        u8 num = Getch();
 415   1        if(isNum(num)==1){
 416   2          if(flag_c == 0){
 417   3              c = c*10 +num;
 418   3          }
 419   2          else{
 420   3              c += num*(float)pow(0.1,flag_c);
 421   3              flag_c ++;
 422   3          }
 423   2        }
 424   1        else if(num == 16){
 425   2          if(flag_c== 0){
 426   3            flag_c = 1;
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 18:00:46 PAGE 8   

 427   3          }
 428   2        } 
 429   1        else if(num == 10){ // +
 430   2          if(multi_div_flag==1){
 431   3            a = a*c;
 432   3            State = 1;
 433   3            add_sub_flag = 1; 
 434   3          }
 435   2          else{
 436   3            a = a/c;
 437   3            State = 1;
 438   3            add_sub_flag = 1; 
 439   3          }
 440   2          initC();
 441   2        }
 442   1        else if (num == 11){ // -
 443   2          if(multi_div_flag==1){
 444   3            a = a*c;
 445   3            State = 1;
 446   3            add_sub_flag = 0; 
 447   3          }
 448   2          else{
 449   3            a = a/c;
 450   3            State = 1;
 451   3            add_sub_flag = 0; 
 452   3          }
 453   2          initC();
 454   2        }
 455   1        else if(num ==12){ // *
 456   2          if(multi_div_flag==1){
 457   3            a = a*c;
 458   3            multi_div_flag = 1; 
 459   3          }
 460   2          else{
 461   3            a = a/c;
 462   3            multi_div_flag = 1; 
 463   3          }
 464   2          State = 5;
 465   2          initC();
 466   2        }
 467   1        else if (num == 13){ // /
 468   2          if(multi_div_flag==1){
 469   3            a = a*c;
 470   3            multi_div_flag = 0; 
 471   3          }
 472   2          else{
 473   3            a = a/c;
 474   3            multi_div_flag = 0; 
 475   3          }
 476   2          initC();
 477   2          State = 5;
 478   2        }
 479   1        else if(num == 17){ // ==
 480   2          State = 0;
 481   2          if(multi_div_flag==1){
 482   3            a = a*c;
 483   3          }
 484   2          else{
 485   3            a = a/c;
 486   3          }
 487   2          initB();
 488   2          initC();
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 18:00:46 PAGE 9   

 489   2        }
 490   1        if(num == 17){
 491   2          LcdWriteData(Outputchar[num]);
 492   2          printans(a);
 493   2        }else{
 494   2          LcdWriteData(Outputchar[num]);
 495   2        }
 496   1      }
 497          void function_S7(){
 498   1        u8 num = Getch();
 499   1      }
 500          void main(){
 501   1        LcdInit();
 502   1        while(1){
 503   2          switch(State){
 504   3            case 0:
 505   3              function_S0();
 506   3              break;
 507   3            case 1:
 508   3              function_S1();
 509   3              break;
 510   3            case 2:
 511   3              function_S2();
 512   3              break;
 513   3            case 3:
 514   3              function_S3();
 515   3              break;
 516   3            case 4:
 517   3              function_S4();
 518   3              break;
 519   3            case 5:
 520   3              function_S5();
 521   3              break;
 522   3            case 6:
 523   3              function_S6();
 524   3              break;
 525   3            case 7:
 526   3              function_S7(); //结果状态
 527   3              break;  
 528   3          }
 529   2        }
 530   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2735    ----
   CONSTANT SIZE    =      3    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     40      19
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
