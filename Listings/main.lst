C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 17:10:31 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\keil5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Final) DEBUG OBJECTEXTEND PRINT(
                    -.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "lcd.h"
   2          #include <reg51.h>
   3          #include <stdio.h>
   4          
   5          typedef unsigned int u16;   //对数据类型进行声明定义
   6          typedef unsigned char u8;
   7          
   8          
   9          char Outputchar[18]={48,49,50,51,52,53,54,55,56,57,43,45,42,47,40,41,46,61};
  10          
  11          float a = 0.0 , b = 0.0, c =0.0 ,ans = 0.0;
  12          u8 flag_a = 0 , flag_b = 0 , flag_c =0 ;
  13          u8 State = 0; //最开始在初始状态
  14          u8 add_sub_flag = 0 ; //1->'+' , 0->'-'
  15          u8 multi_div_flag = 0 ; //1->'*' , 0->'/'
  16          
  17          void printans(float a){
  18   1        u8 i ;
  19   1        char str[8];
  20   1        sprintf(str,"%f",a);
  21   1        LcdWriteCom(0xc0); //定位到第二行
  22   1        for(i= 0 ; i< 8 ; i++){
  23   2          LcdWriteData(str[i]);
  24   2        }
  25   1      }
  26          void delay(u16 i){  
  27   1        while(i--);
  28   1      }
  29          /*
  30            P17->H1
  31            P16->H2
  32            P15->H3
  33            P14->H4
  34          
  35            P13->L1
  36            P12->L2
  37            P11->L3
  38            P10->L4
  39          */
  40          #define GPIO_KEY P1 //  0000 0000
  41          #define GPIO_BUTTON P3 //独立按键使用P3
  42          sbit K1 = P3^0; sbit K2 = P3^1;
  43          sbit K3 = P3^2; sbit K4 = P3^3;
  44          sbit K5 = P3^4; sbit K6 = P3^5;
  45          sbit K7 = P3^6; sbit K8 = P3^7;
  46          u8 isNum(u8 num){
  47   1        if((num>=0)&&(num<=9))
  48   1          return 1;
  49   1        return 0;
  50   1      }
  51          
  52          u8 KeyDown(void)
  53          {
  54   1        u8 KeyValue= 127;
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 17:10:31 PAGE 2   

  55   1        char adelay=0;
  56   1        GPIO_KEY=0x0f;
  57   1        if(GPIO_KEY!=0x0f)//读取按键是否按下
  58   1        {
  59   2          delay(1000);//延时10ms进行消抖
  60   2          if(GPIO_KEY!=0x0f)//再次检测键盘是否按下
  61   2          { 
  62   3            //测试列
  63   3            GPIO_KEY=0X0F;
  64   3            switch(GPIO_KEY)
  65   3            {
  66   4              case(0X07): KeyValue=0;break;
  67   4              case(0X0b): KeyValue=1;break;
  68   4              case(0X0d): KeyValue=2;break;
  69   4              case(0X0e): KeyValue=3;break;
  70   4            }
  71   3            //测试行
  72   3            GPIO_KEY=0XF0;
  73   3            switch(GPIO_KEY)
  74   3            {
  75   4              case(0X70): KeyValue=KeyValue;break;
  76   4              case(0Xb0): KeyValue=KeyValue+4;break;
  77   4              case(0Xd0): KeyValue=KeyValue+8;break;
  78   4              case(0Xe0): KeyValue=KeyValue+12;break;
  79   4            }
  80   3            
  81   3          }
  82   2        }
  83   1        //delay(1000);
  84   1        while((adelay<50)&&(GPIO_KEY!=0xf0))   //检测按键松手检测
  85   1        {
  86   2          delay(150);
  87   2          adelay++;
  88   2        }
  89   1        return KeyValue;
  90   1      }
  91          
  92          
  93          /*
  94          从独立按键输入字符
  95          */
  96          u8 keypros(){
  97   1        
  98   1        
  99   1        GPIO_BUTTON = 0xff;
 100   1        delay(1000);
 101   1        if(K1 == 0){
 102   2          while(!K1);
 103   2          return 10;  //'+'
 104   2        }
 105   1        if(K2 == 0){
 106   2          while(!K2);
 107   2          return 11; 
 108   2        }
 109   1        if(K3 == 0){
 110   2          while(!K3);
 111   2          return 12; 
 112   2        }
 113   1        if(K4 == 0){
 114   2          while(!K4);
 115   2          return 13; 
 116   2        }
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 17:10:31 PAGE 3   

 117   1        if(K5 == 0){
 118   2          while(!K5);
 119   2          return 14; 
 120   2        }
 121   1        if(K6 == 0){
 122   2          while(!K6);
 123   2          return 15; 
 124   2        }
 125   1        if(K7 == 0){
 126   2          while(!K7);
 127   2          return 16; 
 128   2        }
 129   1        if(K8 == 0){
 130   2          while(!K8);
 131   2          return 17; 
 132   2        }
 133   1        return 127;
 134   1      }
 135          
 136          u8 Getch(){
 137   1        u8 op = 127;
 138   1        while(op==127){
 139   2          op = keypros();
 140   2          if(op!=127)
 141   2            return op ;
 142   2          op = KeyDown();
 143   2          if(op!=127){
 144   3          return op;
 145   3          }
 146   2        }
 147   1        return 127;
 148   1      }
 149          
 150          
 151          void function_S0(){
 152   1        u8 num = Getch();
 153   1        if(num == 17){
 154   2          LcdWriteData(Outputchar[num]);
 155   2          printans(a);
 156   2        }
 157   1        else {
 158   2          if(isNum(num)==1){
 159   3            a = a*10 +num;
 160   3          }
 161   2          else if(num == 10){  // + -
 162   3            b = 0 ;
 163   3            add_sub_flag = 1;
 164   3            State = 1;
 165   3          }
 166   2          else if(num == 11){
 167   3            b = 0 ;
 168   3            add_sub_flag = 0 ;
 169   3            State = 1;
 170   3          }
 171   2          else if(num ==12 ){
 172   3            c = 0 ;
 173   3            State = 5;
 174   3            multi_div_flag = 1;
 175   3          }// * /
 176   2          else if(num == 13){
 177   3            c = 0 ;
 178   3            State =5 ;
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 17:10:31 PAGE 4   

 179   3            multi_div_flag = 0;
 180   3          }
 181   2          LcdWriteData(Outputchar[num]);
 182   2        }
 183   1      }
 184          
 185            
 186          
 187          void function_S1(){
 188   1        u8 num = Getch();
 189   1        if(isNum(num)==1){
 190   2          b = num;
 191   2          State = 2;
 192   2          LcdWriteData(Outputchar[num]);
 193   2        }
 194   1        else if(num == 10){ //+
 195   2          
 196   2        }
 197   1        else if(num == 11){ //-
 198   2        }
 199   1        else {
 200   2        }
 201   1      }
 202          
 203          void function_S2(){
 204   1        u8 num = Getch();
 205   1        if(num==17){
 206   2          State = 0;
 207   2          if(add_sub_flag ==1){
 208   3            a = a+b;
 209   3          }
 210   2          else 
 211   2            a = a-b;
 212   2          LcdWriteData(Outputchar[num]);
 213   2          printans(a);
 214   2        }
 215   1        else{
 216   2          if(isNum(num) == 1){
 217   3            b = b*10 + num;
 218   3          }
 219   2          else if (num== 12){  //*
 220   3            c = 0;
 221   3            State = 3;
 222   3            multi_div_flag = 1;
 223   3          }
 224   2          else if (num == 13){ // /
 225   3            c = 0;
 226   3            State = 3; 
 227   3            multi_div_flag = 0;
 228   3            LcdWriteData(Outputchar[num]);
 229   3          }
 230   2          else if (num == 10){
 231   3            if(add_sub_flag ==1){
 232   4              a = a+b;
 233   4            }
 234   3            else 
 235   3              a = a-b;
 236   3            State = 1;
 237   3            add_sub_flag = 1;
 238   3          }
 239   2          else if (num == 11){
 240   3            if(add_sub_flag ==1){
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 17:10:31 PAGE 5   

 241   4              a = a+b;
 242   4            }
 243   3            else 
 244   3              a = a-b;
 245   3            State = 1;
 246   3            add_sub_flag = 0;
 247   3            }
 248   2          LcdWriteData(Outputchar[num]);
 249   2        }
 250   1      }
 251          
 252          void function_S3(){
 253   1        u8 num = Getch();
 254   1        if(isNum(num)==1){
 255   2          c = num;
 256   2          State = 4;
 257   2          LcdWriteData(Outputchar[num]);
 258   2        }
 259   1        else {
 260   2        }
 261   1      }
 262          
 263          void function_S4(){
 264   1        u8 num = Getch();
 265   1        if(isNum(num)==1){
 266   2          c = c*10+num;
 267   2        }
 268   1        else if(num == 10){ // +
 269   2          if(add_sub_flag == 1){
 270   3            if(multi_div_flag ==1)
 271   3              a= a+b*c;
 272   3            else
 273   3              a= a+b/c;
 274   3          }
 275   2          else{ 
 276   3            if(multi_div_flag ==1)
 277   3              a= a-b*c;
 278   3            else
 279   3              a= a-b/c;
 280   3          }
 281   2          b = 0 ; 
 282   2          c = 0;
 283   2          add_sub_flag = 1;
 284   2          State = 1;
 285   2        }
 286   1        else if(num == 11){
 287   2          if(add_sub_flag == 1){
 288   3            if(multi_div_flag ==1)
 289   3              a= a+b*c;
 290   3            else
 291   3              a= a+b/c;
 292   3          }
 293   2          else{ 
 294   3            if(multi_div_flag ==1)
 295   3              a= a-b*c;
 296   3            else
 297   3              a= a-b/c;
 298   3          }
 299   2          b = 0 ; 
 300   2          c = 0;
 301   2          add_sub_flag = 0;
 302   2          State = 1;
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 17:10:31 PAGE 6   

 303   2        }
 304   1        else if(num == 12){ //*
 305   2          if(multi_div_flag == 1){
 306   3            b = b*c ;
 307   3          }
 308   2          else 
 309   2            b = b/c;
 310   2          c = 0 ;
 311   2          State =3;
 312   2          multi_div_flag = 1;
 313   2        }
 314   1        else if(num == 13){ // /
 315   2          if(multi_div_flag == 1){
 316   3            b = b*c ;
 317   3          }
 318   2          else 
 319   2            b = b/c;
 320   2          c = 0 ;
 321   2          State =3;
 322   2          multi_div_flag = 0;
 323   2        }
 324   1        else if(num == 17){
 325   2          if(add_sub_flag == 1){
 326   3            if(multi_div_flag ==1)
 327   3              a= a+b*c;
 328   3            else
 329   3              a= a+b/c;
 330   3          }
 331   2          else{ 
 332   3            if(multi_div_flag ==1)
 333   3              a= a-b*c;
 334   3            else
 335   3              a= a-b/c;
 336   3          }
 337   2          b = 0 ; 
 338   2          c = 0;
 339   2          add_sub_flag = 0;
 340   2          State = 0;
 341   2        }
 342   1        
 343   1        if(num!=17){
 344   2          LcdWriteData(Outputchar[num]);
 345   2        }
 346   1        else{
 347   2          LcdWriteData(Outputchar[num]);
 348   2          printans(a);
 349   2        }
 350   1      }
 351          
 352          void function_S5(){
 353   1        u8 num = Getch();
 354   1        if(isNum(num)==1){
 355   2          c = num;
 356   2          State = 6;
 357   2          LcdWriteData(Outputchar[num]);
 358   2        }
 359   1        else {
 360   2        }
 361   1      }
 362          
 363          void function_S6(){
 364   1        u8 num = Getch();
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 17:10:31 PAGE 7   

 365   1        if(isNum(num)==1){
 366   2          c = c*10 +num;
 367   2        }
 368   1        else if(num == 10){ // +
 369   2          if(multi_div_flag==1){
 370   3            a = a*c;
 371   3            c = 0 ;
 372   3            State = 1;
 373   3            add_sub_flag = 1; 
 374   3          }
 375   2          else{
 376   3            a = a/c;
 377   3            c = 0 ;
 378   3            State = 1;
 379   3            add_sub_flag = 1; 
 380   3          }
 381   2        }
 382   1        else if (num == 11){ // -
 383   2          if(multi_div_flag==1){
 384   3            a = a*c;
 385   3            c = 0 ;
 386   3            State = 1;
 387   3            add_sub_flag = 0; 
 388   3          }
 389   2          else{
 390   3            a = a/c;
 391   3            c = 0 ;
 392   3            State = 1;
 393   3            add_sub_flag = 0; 
 394   3          }
 395   2        }
 396   1        else if(num ==12){ // *
 397   2          if(multi_div_flag==1){
 398   3            a = a*c;
 399   3            c = 0 ;
 400   3            multi_div_flag = 1; 
 401   3          }
 402   2          else{
 403   3            a = a/c;
 404   3            c = 0 ;
 405   3            multi_div_flag = 1; 
 406   3          }
 407   2          State = 5;
 408   2        }
 409   1        else if (num == 13){ // /
 410   2          if(multi_div_flag==1){
 411   3            a = a*c;
 412   3            c = 0 ;
 413   3            multi_div_flag = 0; 
 414   3          }
 415   2          else{
 416   3            a = a/c;
 417   3            c = 0 ;
 418   3            multi_div_flag = 0; 
 419   3          }
 420   2          State = 5;
 421   2        }
 422   1        else if(num == 17){ // ==
 423   2          State = 0;
 424   2          if(multi_div_flag==1){
 425   3            a = a*c;
 426   3            b = c = 0;
C51 COMPILER V9.60.0.0   MAIN                                                              01/04/2021 17:10:31 PAGE 8   

 427   3          }
 428   2          else{
 429   3            a = a/c;
 430   3            b = c = 0 ;
 431   3          }
 432   2        }
 433   1        if(num == 17){
 434   2          LcdWriteData(Outputchar[num]);
 435   2          printans(a);
 436   2        }else{
 437   2          LcdWriteData(Outputchar[num]);
 438   2        }
 439   1      }
 440          void function_S7(){
 441   1        u8 num = Getch();
 442   1      }
 443          void main(){
 444   1        LcdInit();
 445   1        while(1){
 446   2          switch(State){
 447   3            case 0:
 448   3              function_S0();
 449   3              break;
 450   3            case 1:
 451   3              function_S1();
 452   3              break;
 453   3            case 2:
 454   3              function_S2();
 455   3              break;
 456   3            case 3:
 457   3              function_S3();
 458   3              break;
 459   3            case 4:
 460   3              function_S4();
 461   3              break;
 462   3            case 5:
 463   3              function_S5();
 464   3              break;
 465   3            case 6:
 466   3              function_S6();
 467   3              break;
 468   3            case 7:
 469   3              function_S7(); //结果状态
 470   3              break;  
 471   3          }
 472   2        }
 473   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2343    ----
   CONSTANT SIZE    =      3    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     40      19
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
